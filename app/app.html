<!DOCTYPE html>
<!--[if IE]><![endif]-->
<!--[if IE 8 ]><html dir="ltr" lang="en" class="ie8"><![endif]-->
<!--[if IE 9 ]><html dir="ltr" lang="en" class="ie9"><![enditef]-->
<!--[if (gt IE 9)|!(IE)]><!-->
<html dir="" lang="">
<!--<![endif]-->
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>42 knots</title>
<base href="/" target="_blank">

<!-- Bootstrap -->
<script src="../pub/js/jquery-2.1.1.min.js" type="text/javascript"></script>
<link href="../pub/css/3.3.5_bootstrap.min.css" rel="stylesheet" media="screen" />
<script src="../pub/js/3.3.5_bootstrap.min.js" type="text/javascript"></script>


<link href="//fonts.googleapis.com/css?family=Open+Sans:400,400i,300,700" rel="stylesheet" type="text/css" />
<!-- link href="catalog/view/theme/default/stylesheet/stylesheet.css" rel="stylesheet" -->
<!-- link href="../pub/fonts/42font/style.css" rel="stylesheet" -->
<link href="../pub/fonts/babelfish/babelfish.css" rel="stylesheet">

<!-- external styling -->
<link rel="preload" href="../pub/images/loading.gif" as="image" type="image/gif">
<link href="../pub/css/twitterstyle.css" type="text/css" rel="stylesheet" media="screen" />
<link href="../pub/css/sidebar.css" type="text/css" rel="stylesheet" media="screen" />

<!-- own js -->
<script src="../pub/js/lostandfound.js" type="text/javascript"></script>
<script src="../pub/js/popup-share.js" type="text/javascript"></script>


<!-- Matomo -->
<script type="text/javascript">
window.onload = function() {
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//42knots.midrehov.com/analytics/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();

};
</script>
<!-- End Matomo Code -->

<style>

	.babelfish {
		font-size: 1.22em;
	}

	.selected {
		border-color: #000000;
		border-width: 1px;
	}

	.tmpltbtn {
		color: #ffe330;
		background-color: rgb(101, 157, 189);
		width: 50px;height: 50px;
	}
</style>
<script type="text/javascript" src="../app/items.js"></script>
</head>

<body>
<div class="navbar navbar-default navbar-static-top" id="topbar">
	<img src="/pub/images/nslogo.png" style="height: 40px;left: 1%;max-width: 100%;transform: translateX(00%);position: absolute;margin-top: 5px; box-shadow: 2px 2px 2px #888;" class="notmobile">
    <ul class="topbar" role="navigation">
		<li><button class="btn btn-link" id="menu"><span class="icon-tiles babelfish"></button></li>
        <li><button class="btn btn-link" id="backwardsbtn"><span class="icon-back babelfish"></span><span class="notmobile">  Back</span></button></li>
		<li><button class="btn btn-link route2" routeto2="ftype=flow"  id="rtstream"><span class="icon-feed42 babelfish"></span><span class="notmobile">  Home</span></button></li>
		<!-- li><button class="btn btn-link route2" routeto2="ftype=stream"  id="rtstream"><span class="icon-boat42 babelfish"></span><span class="notmobile">  Stream</span></button></li -->
        <li><img src="/pub/images/rss-wifi-signal-preloader-gif.gif" style="max-height: 33px; display: none;" id="countdown"></li>
        <li><form id="search"><input type="text" class="form-control-nav" id="searchi" aria-describedby="search1" name="find" placeholder="search"></form></li>
    </ul>

</div>
<!-- sidebar addition-->
<!-- https://codepen.io/vincebrown/pen/yyLNPR -->
<nav class="sidenav hidden" id="sidebar">
	<ul class="ulsidenav">
		<li><button class="sideitems btn-link route2" routeto2="ftype=fbt" id="rtfbt"><span class="icon-film babelfish"></span><span class=""> Channels</span></button></li>
	  
        <li><button class="sideitems btn-link popup-share" id="editpasswordbtn"><span class="icon-key babelfish"></span><span class="">  Password</span></button></li>
        
        <li><button class="sideitems btn-link" id="rtout"><span class="icon-exit babelfish"></span><span class=""> Log out</span></button></li>

		  
	</ul>
  </nav>


<!-- -->


<div class="container">
	<div class="row">
		<div class="col-sm-1 col-md-2 col-lg-3">
		</div>
		<div class="col-sm-10 col-md-8 col-lg-6">

			<div class="panel-heading view view-fbt" style="display: block;">
				<div class="media">
					
					<div class="media-body">
						<div class="form-group has-feedback">
								<button id="addChannel" aria-describedby="search" class="form-control btn btn42"><span class="icon-film babelfish"></span></button>
						</div>
					</div>
				</div>
			</div>
			
			<div class="panel-heading view view-item">
				<div class="media">
					<form action="" method="post" enctype="multipart/form-data" id="fetchform">
						<div class="media-body">
							<div class="form-group has-feedback">
								<label class="control-label sr-only" for="inputSuccess5">Hidden label</label>

									<input type="hidden" name="iaction" value="fetchnadd">
									<input type="hidden" name="tags" value="">
									<input type="text" class="form-control in42" id="fetch" aria-describedby="search" name="fetchurl" placeholder="paste a url...">

								<span class="icon-chain babelfish form-control-feedback" aria-hidden="true"></span>
								<span id="search2" class="sr-only">(success)</span>
							</div>
						</div>
						<a class="media-left">
							<button class="btn btn-xs btn42"><span class="icon-cube babelfish"></span></button>
						</a>
				</form>
				</div>
			</div>

			<div class="panel panel-info">
			    

				<div class="panel-body" id="main">
                <div id="newitem0">
                    
                </div>

				</div>
			</div>

			<br>
			<br>
			<br>


			<div class="panel panel-default notmobile">
			</div>
		</div>

		<div class="col-sm-1 col-md-2 col-lg-3"></div>
	</div>
</div>
<template id="start" routeto2="ftype=flow"></template>
<template id="artloadwrapper">
	<div class="media media-item" id="artloading">
						  <img src="../pub/images/loading.gif" style="display: block;margin-left: auto;margin-right: auto;width: 50%; padding: 10px;">
	  </div>
</template>
<div id="change_password0"  style="display:none;">
    <form action="" method="post" enctype="multipart/form-data" class="change_password" id="change_password">
        <input type="hidden" name="iaction" value="password">
	    <input type="password" class="form-control input_edit_style" aria-describedby="search" name="curpass"  value="" placeholder="current password">
	        <input type="password" class="form-control input_edit_style" aria-describedby="search" name="newpass"  value="" placeholder="new password">
	        <div class="input-group">
		        <input type="password" class="form-control input_edit_style" aria-describedby="search" name="confirm"  value="" placeholder="confirm new password" id="confirm">
	            <span class="input-group-btn">
	                <button type="submit" class="btn btn-default btn-twitter gopass"><span class="icon-power babelfish"></span></button>
	            </span>
            </div>
        
	</form>
    <span style="color: red;" id="errormsg"></span>
</div>
<div id="template-selector" style="display:none;">
    <div class="social-icons" style="text-align: center; font-weight: 300; background-image: linear-gradient(rgb(255, 255, 255), rgb(240, 240, 240))">
        <ul style="list-style: none; margin: 0px 0px 5px 0px; padding: 2px; float: right;">
            <li style="display: inline-block; zoom: 1; *display: inline; vertical-align: middle;"><button class="btn tmpltbtn tmp_42knots" tmplt="42knots"><span class="icon-boat42"></span></button></li>
            <li style="display: inline-block; zoom: 1; *display: inline; vertical-align: middle;"><button class="btn tmpltbtn tmp_news" tmplt="news"><span class="icon-newspaper"></span></button></li>
            <li style="display: inline-block; zoom: 1; *display: inline; vertical-align: middle;"><button class="btn tmpltbtn tmp_cards" tmplt="cards"><span class="icon-tiles"></span></button></li>
        </ul>
        <br>
        <span>choose</span>
        <span style="color: red;" id="errormsg"></span>
    </div>
</div>
<script type="text/javascript">
	
	/******/
	// global functions and 1st load set
	// declare and set global vars:
	    var constants = {};
	    var routetos = {
	        "fbt" : {
                "ftype" : "fbt"
	        },
	        "stream" : {
                "ftype" : "stream"
	        },
	        "flow" : {
                "ftype" : "flow"
	        },
	        "settings" : {
                "ftype" : "item"
	        },
	        "channel" : {
                "ftype" : "channel"
	        },
	        "rsearch" : {
	            "ftype" : "rsearch"
	        }
	    }
	    var routehistory = [];
	    
		var ftype = ''; // 'stream';
		var objsjson = {}; // 'https://42knots.midrehov.com/index.php?route=retailer/app/json&ftype=flow' // <b>Notice</b>: Undefined variable: feed in <b>/home/midrehov/public_html/42knots/catalog/view/theme/default/template/retailer/app.tpl</b> on line <b>197</b>;
		var objsjson0 = {};
		me = 0; // 1;
		var chtypes = {

		        "me": {
		            "flow":{
		                "actions":["editbutton","templatebutton"],
		                "icon": "fa fa-rss",
		                "editfunc" : "editRetailerBtn",
						"classHidden":{}
		            },
		            "stream":{
		                "actions":["editbutton","templatebutton"],
		                "icon": "fa fa-boat",
		                "editfunc" : "editRetailerBtn",
						"classHidden":{}
		                },
		            "fbt":{
		                "actions":["editbutton","templatebutton"],
		                "icon": "fa fa-tags",
		                "editfunc" : "editFbtBtn",
						"classHidden":{
							"profile": "hidden",
							"handle": "hidden",
							"flowstring": "hidden"
							}
		            },
		            "flows":{
		                "actions":[],
		                "icon": "fa fa-rss",
		                "editfunc" : "",
						"classHidden":{}
		            }
		        },
		        "notme": {
		            "flow":{
		                "actions":["followbutton"],
		                "icon": "fa fa-rss",
		                "editfunc" : ""
		            },
		            "stream":{
		                "actions":["followbutton"],
		                "icon": "fa fa-boat",
		                "editfunc" : "",
						"classHidden":{}
		            },
		            "fbt":{
		                "actions":[],
		                "icon": "fa fa-tags",
		                "editfunc" : "",
						"classHidden":{
							"profile": "hidden",
							"handle": "hidden",
							"flowstring": "hidden"
							}
		            },
		            "flows":{
		                "actions":[],
		                "icon": "fa fa-rss",
		                "editfunc" : "",
						"classHidden":{}
		            }
		        }
		    
		};
		var objsheader = {};
		var tagsarray = {};
		var laf = new lostandfound();
		var popup = {}; // default items
		var channelEditFunc = 'editRetailerBtn';
		var baseurl = ''; // 'https://42knots.midrehov.com/';
		var fortytwobase ='';
		var channelbase = '';

		// scroller vars
    	const displayamount = 20; // the items per 'page'
    	const minload = 20;
    	var currentdisplay = 0; // the total items already displayed
    	var listlength = 0; // Object.keys(cardsjson).length; // the current length of the list
    	var sliceat = 0;
    	var sliced = 0;
    	var scrolliterations = 0;
    	var bulk = 0;
		var antibulk = -1;
		var alreadyrestarted = 0;
        // scroller vars

		var params = routetos.stream; //  a global var, holding the current page info
		var params2 = routetos.stream; //  a global var, holding the current page info
		var itemslist = '';
		var faction = '';
		var actbase = '';
		var actobj = '';
		var retaileredit = '';
		var tagsaction = '';
		var feedlink = '';
		var feedsrc = '';

		var ctrlr = {};
		const webshare = (navigator.share !== undefined);
		//const popupShareItem5 = {"attachment":"main","tmpltId" : "itemSharer"};
		const popupShareDelta = {
			    "attachment":"main",
			    "tmpltId" : "channelSharer",
                "destinations": {
                      	"webapp": {
                    		"textcolor": "#ffe330",
                    		"background": "rgb(101, 157, 189)",
							"icon":"webapp",
                    		"linkbase":"https://42knots.midrehov.com/42/6x7.php?v=webapp&channel=" // fortytwobase = 'apps/cards.html?channel=';'
                    	},
                      	"rss": {
                    		"textcolor": "#ffffff",
                    		"background":"#ee802f",
							"icon":"rss",
                    		"linkbase":"https://42knots.midrehov.com/42/6x7.php?v=rss&channel=" // fortytwobase = '6x7.php?channel=';
						},
						"feedly": {
                    		"textcolor": "#2bb24c",
                    		"background":"#fff",
							"icon":"feedly babelfish",
                    		"linkbase":"https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2F42knots.midrehov.com%2F42%2F6x7.php%3Fv%3Drss%26channel%3D"
						}
						,
						"facebook": {
                    		"textcolor": "#fff",
                    		"background":"#3b5998",
							"icon":"facebook",
                    		"linkbase":"https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2F42knots.midrehov.com%2F42%2F6x7.php%3Fv%3Drss%26channel%3D"
						}/*
						,
						"twitter": {
                    		"textcolor": "#fff",
                    		"background":"#1da1f2",
							"icon":"twitter",
                    		"linkbase":"https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2F42knots.midrehov.com%2F42%2F6x7.php%3Fv%3Drss%26channel%3D"
						}
						,
						"linkedin": {
                    		"textcolor": "#fff",
                    		"background":"#0077b5",
							"icon":"linkedin",
                    		"linkbase":"https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2F42knots.midrehov.com%2F42%2F6x7.php%3Fv%3Drss%26channel%3D"
						}*/
						,
                      	"json": {
                    		"textcolor": "#32CD32",
                    		"background":"#000000",
							"icon":"json",
                    		"linkbase":"https://42knots.midrehov.com/42/6x7.php?v=json&channel=" // fortytwobase = '6x7.php?channel=';
						}
						/*,
						"spacer": {
                    		"textcolor": "#ffffff",
                    		"background":"#ffffff",
                    		"fa":"rss",
                    		"linkbase":""
                    	},
                    	"postrss": {
                    		"textcolor": "#ffffff",
                    		"background":"#F04F23",
                    		"fa":"comment-o",
                    		"linkbase":"https://app.postrss.com/r/9711"
                    	},
                      	"mailchimp": {
                    		"textcolor": "#000000",
                    		"background":"#FFe01B",
                    		"fa":"envelope", // mailchimp
                    		"linkbase":"https://mailchimp.com/help/share-your-blog-posts-with-mailchimp/?"
                    	},
                      	"flipboard": {
                    		"textcolor": "#ffffff",
                    		"background":"#e12828",
                    		"fa":"signal",
                    		"linkbase":"https://about.flipboard.com/inside-flipboard/new-feed-your-rss-feed-into-a-flipboard-magazine/?"  		
						}
						,
                      	"facebook": {
                    		"textcolor": "#ffffff",
                    		"background":"#3b5998",
                    		"fa":"facebook-square",
                    		"linkbase":"https://www.facebook.com/sharer/sharer.php?u=https://42knots.midrehov.com/42/apps/cards.html?channel="  		
                    	}
                    	*/
                    }
            };
		
		const fbt = {
			"func" : "drawchannel",
			"loopsobj" : "feed",
			"otype" : "fbt",
			"eventTriggers" : "fbtEventsTriggers",
			"specsFunc" : "specsFbt",
			"popupParams": popupShareDelta
		};

		const flows = {
			"func" : "drawchannel",
			"loopsobj" : "feed",
			"otype" : "fbt", // which elements shold be displayed or hidden - identical to fbt
			"eventTriggers" : "fbtEventsTriggers",
			"specsFunc" : "specsFbt",
			"popupParams": popupShareDelta
		};

		const item = {
			"func" : "drawitem",
			"loopsobj" : "feed",
			"otype" : "item",
			"eventTriggers" : "itemEventsTriggers",
			"specsFunc" : "specsItem",
			"popupParams": popupShareItem
		};
		
		const channels = {
			"func" : "drawchannel",
			"loopsobj" : "feed",
			"otype" : "fbt", // which elements shold be displayed or hidden - identical to fbt
			"eventTriggers" : "fbtEventsTriggers",
			"specsFunc" : "specsFbt",
			"popupParams": popupShareDelta
		};

        function validateFetch(response) {
			switch (true) {
                
				case (response.status >= 300 && response.status < 400):
					window.location.href = response.location;
				break;
				
				case response.redirected && response.status == 200:
					window.location.href = response.url;
				break;

				case (response.status >= 500 && response.status < 600):
					document.getElementById("countdown").style.display = "none";
					throw new Error('Whoops!');
				break;
				case (response.status >= 400 && response.status < 500):
					window.location.href = baseurl;
				break;
/*
				case response.json.length == 0:
					//throw new Error("Something went badly wrong!");
					console.log(response);
				break;
*/
				case response.status == 200:
					return response;
				break;

				default:
					window.location.href = baseurl;
				break;
			}
        }
        /**/
 
		function loader(ctrlr) {
			$(".tmpltbtn").removeClass("selected");
			$("[id*=popover]").remove();
			clearElemId('main');
        	currentdisplay = 0; // the total items already displayed
        	listlength = 0; // Object.keys(cardsjson).length; // the current length of the list
        	sliceat = 0;
        	sliced = 0;
    	    scrolliterations = 0;
			
			//loopitems(objsjson[ctrlr.loopsobj],'main',ctrlr.func); /* loop through the sliced*/
			$("#main").append(loopitems(objsjson[ctrlr.loopsobj],ctrlr.func));
			window[ctrlr.eventTriggers](bulk);
			// currentdisplay = listlength + displayamount
			listlength = Object.keys(objsjson[ctrlr.loopsobj]).length;
			scrolliterations++;
			//
			
			window[ctrlr.specsFunc]();
			displayView(ctrlr.otype);

			
		}
		
		function init() {
		    
		    objsjson0 = JSON.parse(JSON.stringify(objsjson));
		    objsjson0.ftype = (' ' + ftype).slice(1);

		    if (typeof objsjson['tagsarray'] != 'undefined') {
		        tagsarray = JSON.parse(JSON.stringify(objsjson['tagsarray']));
		        delete objsjson['tagsarray'];
		    }
		    
		    switch(ftype) {
        	    case 'fbt':
        		    ctrlr = channels; // fbt
        	    break;
        	    case 'flow':
        	        objsheader = JSON.parse(JSON.stringify(objsjson['feed']));
        	        objsjson['feed'] = objsjson['feed']['items'];
		  	        delete objsheader['items'];
        		    ctrlr = item;
        		break;
        	    case 'channel':
        	        objsheader = JSON.parse(JSON.stringify(objsjson['feed']));
        	        objsjson['feed'] = objsjson['feed']['items'];
		  	        delete objsheader['items'];
        		    ctrlr = item;
                break;
        	    case 'flows':
        		    ctrlr = channels; // flows
                break;
        	    case 'rsearch':
        		    ctrlr = channels;
                break;                
        	    case 'stream': // obsolete, once a channel is treated
        	        objsheader = JSON.parse(JSON.stringify(objsjson['feed']));
        	        objsjson['feed'] = objsjson['feed']['items'];
		  	        delete objsheader['items'];
        		    ctrlr = item;
                break;
        	    default: // channel
        	        objsheader = JSON.parse(JSON.stringify(objsjson['feed']));
        	        objsjson['feed'] = objsjson['feed']['items'];
		  	        delete objsheader['items'];
        		    ctrlr = item;
		    	}
		    	

		    actobj = actbase +  '&otype=' + ctrlr.otype;		    	
		    bulk = 0;
    	    antibulk = -1;
        	loader(ctrlr);
			//popup = new popupShare(ctrlr.popupParams);
			alreadyrestarted = 0;
		}

		function inituser() {
			fetch(baseurl + '?route=retailer/app/json&ftype=constants', {
			method: 'GET'
			})
			.then(function(response) {
				return validateFetch(response);
			})
			.then(function(response) {
				return response.json();
			})
			.then(function(json) {
				constants2 = JSON.parse(JSON.stringify(json));
				localStorage['42knots,constants'] = JSON.stringify(json);
				let mecache = true;
				let tempcnts = {};
				tempcnts.me = 0;
				if (typeof constants !== 'undefined') {
					tempcnts = constants2;
				}
				if(tempcnts.me !== constants.me) {
					mecache = false;
				}
				setConstants(constants2);
				nonRecurringEventsTriggers();
				if(mecache) {
        			scrollEvents();
					loadOnRefresh();
				} else {
					routeto2("start");
				}
				
			});
		}

    	function drawchannel(channel,chtypes) {
    	    
    	    let tmplt = '';
    	    dirclass = 'directionl';
    	    if (typeof channel.language != 'undefined' && ((channel.language == 'he') || (channel.language == 'ar'))) {
              dirclass = 'directionr';
            }
            
            if (typeof channel['channel_id'] == 'undefined' || channel['channel_id'] == "null") {
                channel['channel_id'] = 0;
            }
            
            // to be imported as a part of channel
            let whois = 'me';
			let titlelink = `ftype=stream&fid=${channel['owner_id']}`;
            if (typeof channel['whois'] == 'undefined') {
                if (channel.owner_id != me && channel.owner_type != 'fbt') {
					whois = 'notme';
				}
            } else {
				whois = channel['whois'];
				titlelink = `channel_id=${channel['channel_id']}`;
			}

			chtview = {
				"profile":"",
				"handle":"",
				"flowstring":"",
				"editbtn":"",
				"templatebtn":""
			}

			chtview = { ...chtview, ...chtypes[whois][channel.owner_type]['classHidden'] };
			let flowstring = `<div class="fcwrapper ${chtview.flowstring}"> <span><a id="achnls_${channel['channel_id']}" class="route2" routeto2="ftype=stream&fid=${channel['owner_id']}" href="#"> Stream </a></span> | <span><a id="achnlf_${channel['channel_id']}" class="route2" routeto2="ftype=flow&fid=${channel['owner_id']}" href="#"> Flow </a></span> | <span><a id="achnlc_${channel['channel_id']}" class="route2" routeto2="ftype=fbt&fid=${channel['owner_id']}" href="#"> Channels </a></span><br> Following <span class="fcounter"><a id="afle_${channel['channel_id']}" class="route2" routeto2="ftype=flows&flowtype=follower&fid=${channel['owner_id']}" href="#">${channel['followers']}</a></span> | Followers <span class="fcounter"><a id="aflr_${channel['channel_id']}" class="route2" routeto2="ftype=flows&flowtype=followee&fid=${channel['owner_id']}" href="#">${channel['followees']}</a></span> </div>`;
            
            let btnbar = {};
            btnbar.editbutton = {
                "jsClass" : "editbtn",
                "idprefix" : "int_id_",
				"icon" : "wrench",
                "wording" : "edit"
            };
            btnbar.templatebutton = {
                "jsClass" : "channel-template",
                "idprefix" : "tmplt_id_",
				"icon" : "image",
                "wording" : "templates"
            };
            btnbar.followbutton = {
                "jsClass" : "followbtn",
                "idprefix" : "owner_id_",
				"icon" : "user-plus",
                "wording" : "follow"
			};
			if(channel.IsFl == "fl") {
				btnbar.followbutton['icon'] = "user-minus";
			}
            btnbar.viewsbutton = {
                "jsClass" : "viewsbtn channel-horn",
                "idprefix" : "horn_",
				"icon" : "bullhorn",
                "wording" : "publish"
            };
    	    let itemsarr = chtypes[whois][channel.owner_type]['actions'];
    	    let btns = {};
			let btnsstr = '';
            btns['editbutton'] = `<button class="${btnbar['editbutton'].jsClass}" id="${btnbar['editbutton'].idprefix}${channel.key}"><span class="icon-${btnbar['editbutton'].icon} babelfish"></span><span>edit</span></button>`;
            btns['templatebutton'] = `<button class="${btnbar['templatebutton'].jsClass}${channel.bulk}" id="${btnbar['templatebutton'].idprefix}${channel.channel_id}"><span class="icon-${btnbar['templatebutton'].icon} babelfish"></span><span>template</span></button>`;
            btns['followbutton'] = `<button class="${btnbar['followbutton'].jsClass}" id="${btnbar['followbutton'].idprefix}${channel.owner_id}"  isfl="${channel.IsFl}"><span class="icon-${btnbar['followbutton'].icon} babelfish"></span><span>follow</span></button>`;
    	    itemsarr.forEach(actn => btnsstr += btns[actn]);
    	    // '<div id="channel_' + channel['key'] + '" class="schannel' + channel.bulk + '" >';
    	    tmplt += `
    	        <div id="channel_${channel['key']}" class="channel schannel${channel.bulk}">
                <div class="card profile-card-2 channel2 media media-item">
                    <div class="card-img-block">
                        <img class="img-fluid" src="${channel.image_url}" alt="Card image cap" id="ch_img_${channel['key']}">
                    </div>
                    <div class="card-body pt-5">
                        <img src="${channel.profile_pic}" alt="profile-image" class="profile ${chtview.profile}">
                        ${flowstring}
                        <h4 class="card-title"><a id="hdlink_${channel['key']}" class="route2" routeto2="${titlelink}" href="#"><span style="font-size: 70%; color:#999999; font-style: italic;" class="${chtview.handle}">@${channel.handle} </span><span id="ch_title_${channel['key']}">${channel.title}</span></a></h5>
                        <p class="card-text" id="ch_description_${channel['key']}">${channel.description}</p>
                        <div class="icon-block">
                            <!-- --> ${btnsstr} <!-- -->
                            <button id="ch_share_${channel['channel_id']}" class="viewsbtn channel-share${channel.bulk}" href="#"> <span class="icon-share babelfish"></span><span>share</span></button>
                            <button id="horn_${channel['channel_id']}" class="viewsbtn channel-horn${channel.bulk}" href="#"> <span class="icon-bullhorn babelfish"></span><span>publish</span></button>
                            
                        </div>
                    </div>
                </div>
            </div>
    	    `;
    	    return tmplt;
    	}
/**/
    	function clearElemId(elemId) {
			document.getElementById(elemId).innerHTML = '';
		}
		
		function displayView(otype) {
			const viewElems = document.getElementsByClassName('view');
			for (let i = 0; i < viewElems.length; i++) {
			    viewElems[i].style.display = "none";
			}
			
		    const disViewElems = document.getElementsByClassName('view' + '-' + otype);
			for (let i = 0; i < disViewElems.length; i++) {
			    disViewElems[i].style.display = "block";
			}
		}

		function loopitems(itemsjson0,func, isBottom = true) {
    		var itemslist0 = '';
			if (typeof itemsjson0 === 'object' && itemsjson0 !== null) {
				currentdisplay += laf.isError(Object.keys(itemsjson0).length,0);
			}
    		for (key in itemsjson0) {
				itemsjson0[key]['key'] = key;
        	    if (typeof itemsjson0[key]['bulk'] == 'undefined') {
                  itemsjson0[key]['bulk'] = bulk;
                }
                
    			itemslist0 += window[func](itemsjson0[key],chtypes);
    		}
    		return itemslist0;
    	}
    	
    	function dummy() {}
    	
    	function specsItem() {
    	    objsheader.bulk = antibulk;
    	    objsheader['key'] = -1;
            objsheader.whois = 'me';
            if(objsheader.owner_type != 'fbt' && objsheader.owner_id != me) {
                objsheader.whois = 'notme';
            }
    	    let header = drawchannel(objsheader,chtypes);
    	     document.body.style.background = "rgba(3, 67, 120, 1) url('" + objsheader.image_url + "') no-repeat center center fixed"; 
    	     document.body.style['background-size'] = "cover";
    	    $("#" + "main").prepend(header);
    	    let channelPopup = popupShareDelta;
    	    channelPopup.tmpltId = "channelSharer";
    	    popup2 = new popupShare(channelPopup);
    	    popup = new popupShare(popupShareItem);
    	    //popup2 = new popupShare(fbt.popupParams);
    	    channelEditFunc = 'editRetailerBtn';
    	    //channelEditFunc = chtypes[whois][channel.owner_type]['editfunc'];
			fbtEventsTriggers(antibulk--,popupShareItem.tmpltId,channelPopup.tmpltId);
			$(".tmp_" + objsheader.template).addClass("selected");

    	}
    	
    	function specsFbt() {
    	    popup2 = new popupShare(popupShareDelta);
    	    popup = new popupShare(popupShareItem);
    	    channelEditFunc = 'editFbtBtn';
    	}
    
        function addform(itemdata) {
            var actn = '';
            var specs = '';
    	    if (typeof itemdata.otype == 'undefined') {
              return;
            }
            if (itemdata.item_id == 0) {
                actn = actobj;
                specs += '<input type="hidden" name="iaction" value="add">';
            } else {
                actn = tagsaction;
            }
            if (typeof tagsarray[itemdata.item_id] == 'undefined') {
                var tags = '';
            } else {
                var tags = tagsarray[itemdata.item_id];
			}
			let dissed = 'disabled'
			if (itemdata.isme == '1') {
				dissed = '';
			}
            
			var tmplt = `<div style="margin-top: 2px;box-shadow: 1px 1px 2px #888888;" class="" id="formtag_${itemdata.item_id}">
						<div class="form-group has-feedback">
    					<label class="control-label sr-only" for="inputSuccess5">Hidden label</label>
    					<form action="${actn}" method="post" enctype="multipart/form-data" class="tagsform" id="tagsform_id_${itemdata.item_id}">`;
			tmplt += specs;
			tmplt += `<input type="hidden" name="obj_id" value="${itemdata.item_id}">
					<input type="hidden" name="otype" value="${itemdata.otype}">
					<input type="text" class="form-control input_edit_style" aria-describedby="search" name="tags" value="${tags}" placeholder="tag by text, comma seperated" ${dissed}>    								</form>
                                <i type="submit" class="fa fa-tags form-control-feedback" aria-hidden="true"></i>
                            </div></div>
    		`;
		return tmplt;
		
        }
		
		function editChannel(channel) {
		    if (typeof channel.iactn == 'undefined') {
              channel.iactn = 'edit';
            }
            if (typeof tagsarray[channel.owner_id] == 'undefined') {
                var tags = '';
            } else {
                var tags = tagsarray[channel.owner_id];
            }
			var tmplt = '';
			let tagsinput = '';
			chtview = {
				"profile":""
			}
			chtview = { ...chtview, ...chtypes['me'][channel.owner_type]['classHidden'] };
			if (channel.owner_type == 'fbt') {
                tagsinput = `<input type="text" class="form-control input_edit_style" aria-describedby="search" name="tags"  value="${tags}" placeholder="tags names, comma seperated">`;
			}
			tmplt += `<div style="margin-top: 2px;box-shadow: 1px 1px 2px #888888;" class="" id="edit_channel_${channel.obj_id}">
				<div class="form-group has-feedback">
												<label class="control-label sr-only" for="inputSuccess5">Hidden label</label>
													<form action="${channel.chaction}" method="post" enctype="multipart/form-data" class="editchform" id="editchform_id_${channel.owner_id}">
													<input type="hidden" name="iaction" value="${channel.iactn}">
													<input type="hidden" name="fbt_id" value="${channel.owner_id}">
													${tagsinput}
													<input type="text" class="form-control in_editchannel input_edit_style" aria-describedby="search" name="title" value="${channel.title}" placeholder="Title" id="title_for_${channel.owner_id}">
													<input type="text" class="form-control in_editchannel input_edit_style" aria-describedby="search" name="description"  value="${channel['description']}" placeholder="Description" id="description_for_${channel.owner_id}">
													<input type="text" class="form-control in_profiepic input_edit_style ${chtview.profile}" aria-describedby="search" name="profile_pic" value="${channel.profile_pic}" placeholder="avatar Icon" id="profile_pic_for_${channel.owner_id}">
													<div class="input-group">
													    <input type="text" class="form-control in_editimg input_edit_style" aria-describedby="search" name="header_image" value="${channel.image_url}" placeholder="Channel header image url" id="img_for_${channel.owner_id}">
                                                                  <span class="input-group-btn btn42">
                                                                    <button type="button" class="btn btn-default btn-twitter submitedit btn42"><span class="icon-power babelfish"></span></button>
                                                                  </span>
                                                                </div>
                                                            </form>
												<i type="submit" class="fa fa-tags form-control-feedback" aria-hidden="true"></i>
											</div>
				</div>`;
				return tmplt;
		}

</script>
<script type="text/javascript">
    /* to remove !
    function routeto(elemId) {
        // global rounting function
        //if (params != routetos[$("#" + elemId).attr('routeto')]) {
        //    params = routetos[$("#" + elemId).attr('routeto')];

        //routeto to hold a json object with parameters: ftype, channel_id if needed
        //ftype is a must, the rest are not
        
            ftype = params.ftype;
            document.getElementById("countdown").style.display = "block";
            let encdParams = laf.objectSerialize(params);
            feedsrc = feedlink + '&' + encdParams;
            fetch(feedsrc  /*+ '&limstart=' + listlength + '&limend=' + (listlength + displayamount, {
                  method: 'GET'
                })
                .then(function(response) {
                    return response.json();
                    
                })
                .then(function(json) {
        			objsjson = json; //JSON.parse(json);
        			init();
        			scrollEvents();
        			document.getElementById("countdown").style.display = "none";
        		    $("html, body").animate({
                        scrollTop: 0
                    }, 9000);
        			$("html, body").on("scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove", function(){
                           $("html, body").stop();
                       });
                })
                //.catch((err) => {                    routeto(rtstream);                });
            
        } 
    }
    */
    /**/
    function routeto2(elemId) {
        // global rounting function
        // https://42knots.midrehov.com/index.php?route=retailer/app/json&{"ftype":"channel","fid":"39"}&limstart=0&limend=20
        let series = $("#" + elemId).attr('routeto2');
        let series2 = series.replace(new RegExp('=', 'g'), '":"');
        series2 = '{"' + series2.replace(new RegExp('&', 'g'), '","') + '"}';
        if (JSON.stringify(params2) != series2) {
            params2 = JSON.parse(series2);

        
            ftype = params2.ftype;
            document.getElementById("countdown").style.display = "block";
            feedsrc = feedlink + '&' + series;
            fetch(feedsrc  , { // + '&limstart=' + listlength + '&limend=' + (listlength + displayamount
                  method: 'GET'
                })
                .then(function(response) {
					return validateFetch(response);
                })
                .then(function(response) {
					return response.json();
                })
                .then(function(json) {
                    // fold the header and the items, case items.
					json.ftype = ftype;
					localStorage['42knots,objsjson'] = JSON.stringify(json); // only strings
                    routehistory.push(JSON.parse(localStorage['42knots,objsjson']));
					delete json.ftype;
                    //delete objsjson0.ftype;
        			objsjson = json; //JSON.parse(json);
        			init();
        			scrollEvents();
        			document.getElementById("countdown").style.display = "none";
        		    $("html, body").animate({
                        scrollTop: 0
                    }, 1700);
        			$("html, body").on("scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove", function(){
                           $("html, body").stop();
                       });
                })
                //.catch((err) => {                    routeto(rtstream);                });
            
        } else if (window.scrollY == 0) {
			loadOnRefresh();
		} else {
			$("html, body").animate({
				scrollTop: 0
			}, 500);
			$("html, body").on("scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove", function(){
					$("html, body").stop();
				});
		}
    }

	$('#searchi').focus(function(){
		$('#searchi').popover({
			placement: 'bottom',
			container: 'body',
			html: true,
			content: function() {
				return 'free text for items, ## for own tagging filter, @ for user search';
			}
		});
	});

	$("#searchi").blur(function(){
		$("[id*=popover]").remove();
	}); 

    $('#search').submit(function(e) {
		e.preventDefault();
	    var routetosearch = {};
	    
        let searchswitch = $("#searchi").val();
        //routetosearch = JSON.parse(JSON.stringify(routetos.stream));
        routetosearch = {
            "ftype" : "stream"
        };
        
        
        if (searchswitch.substring( 0, 2) == '##') {
            //routetosearch.ftype = 'stream';
            routetosearch.gvalue = searchswitch.substring( 2, searchswitch.length);
        } else if (searchswitch.substring( 0, 1) == '@') {
            routetosearch.ftype = 'rsearch';
            routetosearch = JSON.parse(JSON.stringify(routetos.rsearch));
            routetosearch.find = searchswitch.substring( 1, searchswitch.length);
        } else {
            routetosearch.find = searchswitch;
        }

        $("#searchi").attr("routeto2",laf.objectSerialize(routetosearch));
	    routeto2("searchi");
    });


</script>
<script type="text/javascript">

    var nonRecurringEventsTriggers = function() {
   
   
		$( "#fetch" ).on('paste', function () {
				 var self = this;
				  setTimeout(function(e) {
					$("#fetchform").submit()
				  }, 0);
		 
			
		});
   
		$('#fetchform').submit(function(e) {
			e.preventDefault();
			if ($("#item_0").length > 0) {
				$("#item_0").remove();
				$("#formtag_0").remove();
			}
			let artld = document.getElementById("artloadwrapper").innerHTML;
			$(artld).insertAfter('#channel_-1');

			$.ajax({
			   type: "POST",
			   url: faction,
			   data: $(this).serialize(),
			   dataType: "json",
			   //dataType: "text",
			   success: function(data)
			   {
					document.getElementById("artloading").remove();
			       if(laf.isJSON(data)) {
			           console.log("fetch Json !");
			       } else {
			           console.log("fetch NOT Json !");
			       }
				   data.item_id = data['obj_id'];
				   data.guid = data.url;
				   data.bulk = antibulk;
				   data.handle = objsheader.handle; // to  arrive from constants
				   data.otype = 'item';
				   data.retailer_id = me;
				   var newitem = drawitem(data,chtypes);
				   $(newitem).insertAfter('#channel_-1');
					itemEventsTriggers(antibulk--,'itemSharer');
					tagsarray[data['obj_id']] = '';
					$("#fetch").val("");

				   //newitem = addform(data);
				   //$("#item_0").append(newitem);
					//$("#item_0").addClass("newObj");
				   	/*
				   $("#tagsform_id_0").submit( function(e) {
    					let tags0 = $("#tagsform_id_0").find('input[name="tags"]').val();
						e.preventDefault();
						var actn = $(this).attr('action');
						$.ajax({
						   type: "POST",
						   url: actn,
						   data: $(this).serialize(),
						   dataType: "json",
						   success: function(data)
						   {
								$('#formtag_0').remove();
								$("#item_0").removeClass("newObj");
								$("#item_0").attr("id","item_" + data['obj_id']);
								$("#tag_item_0").attr("id","tag_item_" + data['obj_id']);
								itemEventsTriggers(antibulk--,'itemSharer');
								tagsarray[data['obj_id']] = tags0;
								$("#fetch").val("");
						   },
							error: function(data) {
								console.log('error adding item: ' + JSON.stringify(data));
								$('#item_0').remove();
							}
							
						   });

				   });
				   */
				},
				error: function(data) {
					document.getElementById("artloading").remove();
					console.log(data.responseText);
				}
				
			   });
		 });
		 
		$("#fetch").keyup(function() {

            if ($(this).val() == '') {
    			if ($("#item_0").length > 0) {
    				$("#item_0").remove();
    				$("#formtag_0").remove();
    			}
            }

        });
		 
                $("#addChannel").click(function(){
                        var myEle = document.getElementById("channel_-1");
                        if(myEle){
                            $("#channel_-1").remove();
                        } else {
        	                const newChannel = {
        	                    'iactn' : 'add',
        	                    'fbt_id' : -1,
        	                    'language' : '',
        	                    'key' : -1,
        	                    'image_url' : '',
        	                    'link' : '',
        	                    'title' : '',
        	                    'description' : '',
        	                    'bulk' : antibulk,
        	                    'chaction': actobj,
								'whois':'me',
								'owner_type': 'fbt',
								'owner_id' : -1,
        	                };
        	               var newitem = drawchannel(newChannel,chtypes);
        	               $("#main").prepend(newitem);
        	               newitem = editChannel(newChannel);
        	               $("#channel_" + newChannel.fbt_id).append(newitem);
        	               // keyups
    						$("input:text.in_editchannel").on('keyup', function() {
    						    dest = $(this).attr('id').split("_");
    						    $("#ch_" + dest[0] + "_" + newChannel.fbt_id).text($(this).val());
    	    		        });
    	    		        $("input:text.in_editimg").on('keyup', function() {
    	    		            var id_ = $(this).attr('id');
    						    dest = id_.split("_");
    						    $("#ch_" + dest[0] + "_" + newChannel.fbt_id).attr("src",$(this).val());
    	    		        });
                            $("input:text.in_profiepic").on('keyup', function() {
    	    		            var id_ = $(this).attr('id');
    						    dest = id_.split("_");
    						    $("#ch_" + dest[0] + "_" + newChannel.fbt_id).attr("src",$(this).val());
    	    		        });   	    		        
                    		$('#channel_-1').on('submit','.editchform',function(e) {
                    			e.preventDefault();
                    			var actn = $(this).attr('action');
                    			var fitem_id = $(this).attr('id').substring(14, $(this).attr('id').length);
                                console.log('actn: ' + actn + ',  actobj: ' + actobj);
                    			$.ajax({
                    			   type: "POST",
                    			   url: actn,
                    			   data: $(this).serialize(),
                    			   dataType: "json",
                    			   success: function(data)
                    			   {
                    			       console.log('#edit_channel_' + fitem_id + ',  before');
                        			    if (actn == actobj) {
                        			        objsjson[ctrlr.loopsobj][fitem_id] = data;
                        			        fbtEventsTriggers(antibulk--,'itemSharer','channelSharer');
                        			    }
                        			    console.log('#edit_channel_' + fitem_id);
                        				$('#editchform_id_' + fitem_id).remove();
                    			   },
                    				error: function(data) {
                    					console.log('error updating tag: ');
                    					console.log(data);
                    					$('#edit_channel_' + fitem_id).remove();
                    				}
                    				
                    			   });
                    			 
                    		 });					    

    	    		        
    	    		        $(".submitedit").on('click', function() {
    	    		            $(".editchform").submit();
    	    		        });

                        }
                });
                /**/
                $('#editpasswordbtn').on('shown.bs.popover', function () {
                    $('.change_password').on('submit',function(e) {
                    	e.preventDefault();
                    	var actn = $(this).attr('action');
                    
                    	$.ajax({
                    	   type: "POST",
                    	   url: actn,
                    	   data: $(this).serialize(),
                    	   dataType: "json",
                    	   success: function(data)
                    	   {
                    	    console.log(data);
                    		$("[id*=popover]").remove();
                    	   },
                    		error: function(data) {
                    			console.log('error updating password: ');
                    			document.getElementById('errormsg').innerHtml = data.reason;
                    			console.log(data);
                    			
                    			
                    		}
                    		
                    	   });
                    	 
                     });    
                
                });
                /**/
                $("#editpasswordbtn").popover({
                      placement: 'bottom',
                      container: 'body',
                      html: true,
                      content: function() {
                        //popup.updatePopUp($(this).attr('routeto'));
                        return document.getElementById('change_password0').innerHTML;
                        
                      }
                }); 
                
                /*
                $("#sidemenubtn").popover({
                    placement: 'bottom',
                    container: 'body',
                    html: true,
                    content: function() {
                    //popup.updatePopUp($(this).attr('routeto'));
                    return `
                        <ul class="topbar">
                            <li><button class="btn btn-link popup-share" ><span>icon-key</span><span class="notmobile">  Settings</span></button></li>
                            <li><button class="btn btn-link popup-share" ><span>icon-key</span><span class="notmobile">  Settings</span></button></li>
                        </u>
                    `;
                    }

                });
                /**/                    
        
    }
    
    var editRetailerBtn = function(bulk = 0,editObj) {
        			var data = {};
        			obj_id = $(editObj).attr('id');

	    		    obj_id = obj_id.substring(7, obj_id.length);
					data = objsheader;
					data.obj_id = obj_id;
					data.chaction = retaileredit;
					data.iactn = 'update';
	    		    

					if ($("#" + "edit_channel_" + data.obj_id).length > 0) {
						$("#" + "edit_channel_" + data.obj_id).remove();
					} else {
					    

						data.otype = ctrlr.otype;
						newitem = editChannel(data);
						$("#channel_" + data.obj_id).append(newitem);
						$("input:text.in_editchannel").on('keyup', function() {
						    dest = $(this).attr('id').split("_");
						    $("#ch_" + dest[0] + "_" + data.obj_id).text($(this).val());
	    		        });
	    		        $("input:text.in_editimg").on('keyup', function() {
						    dest = $(this).attr('id').split("_");
						    $("#ch_" + dest[0] + "_" + data.obj_id).attr("src",$(this).val());
	    		        });
	    		        $("input:text.in_editprofile").on('keyup', function() {
						    dest = $(this).attr('id').split("_");
						    $("#ch_" + dest[0] + "_" + data.obj_id).attr("src",$(this).val());
	    		        });

	    		        
	    		        $(".submitedit").on('click', function() {
	    		            $(".editchform").submit();
	    		        });
					}
        
    };

    var editFbtBtn = function(bulk = 0,editObj) {
        			var data = {};
        			obj_id = $(editObj).attr('id');

	    		    obj_id = obj_id.substring(7, obj_id.length);
					data = objsjson[ctrlr.loopsobj][obj_id];
					data.obj_id = obj_id;
					data.chaction = actobj;
	    		    

					if ($("#" + "edit_channel_" + data.obj_id).length > 0) {
						$("#" + "edit_channel_" + data.obj_id).remove();
					} else {
					    

						data.otype = ctrlr.otype;
						newitem = editChannel(data);
						$("#channel_" + data.obj_id).append(newitem);
						$("input:text.in_editchannel").on('keyup', function() {
						    dest = $(this).attr('id').split("_");
						    $("#ch_" + dest[0] + "_" + data.obj_id).text($(this).val());
	    		        });
	    		        $("input:text.in_editimg").on('keyup', function() {
						    dest = $(this).attr('id').split("_");
						    $("#ch_" + dest[0] + "_" + data.obj_id).attr("src",$(this).val());
	    		        });
	    		        
	    		        $(".submitedit").on('click', function() {
	    		            $(".editchform").submit();
	    		        });
					}
    };
	
	var fbtEventsTriggers = function(bulk = 0, popupShareId = 'itemSharer',popupDeltaId = 'channelSharer') {
	            
	            var ch_id = 0;
	            
                /*$(".schannel" + bulk + " .route").click(function(e){
                    e.preventDefault();
                    routeto($(this).attr('id'));
                    
                });*/

                $(".schannel" + bulk + " .route2").click(function(e){
                    e.preventDefault();
                    routeto2($(this).attr('id'));
                });

	    		$(".schannel" + bulk + " .editbtn").click(function(e){
	    		    e.preventDefault();
	    		    window[channelEditFunc](bulk,$(this));
	    		});
	    		
	    		$(".schannel" + bulk + " .followbtn").click(function(e){
	    		    e.preventDefault();
	    		    console.log('follow or unfollow, that is the question');
	    		    let followee = $(this).attr('id'); // str.substring(3, 4);
	    		    followee = followee.substring(9, followee.length);
	    		    let ths = $(this);
	    		    let isfl =  $(this).attr('isfl');
	    		    let spanf = $(this).find("span");
	    		    //let ifl = $(this).find("i");
	    		    /**/
	    		    
                    fetch(baseurl + 'index.php?route=retailer/flow/AddRemoveFlow', // flwunflow
                    {
                        method: "POST",
                        body: "followee=" + followee
					})
                    .then(function(res){
                        return res.json();
                    })
                    .then(function(data){
                        if (data['status'] == 'ok') {
                            if (isfl == 'fl') {
                                console.log($("aflr_" + followee));
								ths.attr('isfl','nfl');
                                $(spanf).attr( 'class','icon-user-plus babelfish');
                                //spanf[0].innerHTML = 'follow';
                                $("aflr_" + followee).text += '-1';
                            } else {
                                console.log($("aflr_" + followee));
								ths.attr('isfl','fl');
                                $(spanf).attr( 'class','icon-user-minus babelfish');
                                //spanf[0].innerHTML = 'unfollow';
                            }
                        } else {
                            console.log("not ok:");
                            console.log(data);
                        }
                    })
                    .catch(error => {
                        console.log(error);
                        })
	    		    
	    		});
	    		
	    		$(".schannel" + bulk + " .openbtn").click(function(){

	    		    ch_id = $(this).attr('id');
	    		    ch_id = ch_id.substring(11, ch_id.length);

	    		    var routetoch = {};
	    		    routetoch = JSON.parse(JSON.stringify(routetos.stream));
	    		    routetoch.channel_id = ch_id;
	    		    routetos.routetoch = routetoch;

	    		    $(this).attr("routeto","routetoch");
	    		    $(this).attr("routeto2","ftype=channel&fid=" + ch_id);
	    		    
	    		    routeto2($(this).attr('id'));
	    		});

                $('.schannel' +bulk).on('submit','.editchform',function(e) {
			e.preventDefault();
			var actn = $(this).attr('action');
			var fitem_id = $(this).attr('id').substring(14, $(this).attr('id').length);
			console.log('fitem_id: ' + fitem_id);

			$.ajax({
			   type: "POST",
			   url: actn,
			   data: $(this).serialize(),
			   dataType: "json",
			   success: function(data)
			   {

    		       console.log('#edit_channel_' + fitem_id + ',  before');
    		       console.log('actn: ' + actn,'actobj: ' + actobj);
    			    if (actn == actobj) {
    			        objsjson[ctrlr.loopsobj][fitem_id] = data;
    			    }
			    //objsjson[ctrlr.loopsobj][fitem_id] = data;
				$('#editchform_id_' + fitem_id).remove();
			   },
				error: function(data) {
					console.log('error: ');
					console.log(data);
					$('#edit_channel_' + fitem_id).remove();
				}
				
			   });
			 
		 });
		 
                $(".channel-horn" + bulk).popover({
                      placement: 'bottom',
                      container: 'body',
                      html: true,
                      content: function() {
                		ch_id = $(this).attr('id');
        	    		ch_id = ch_id.substring(5, ch_id.length);
                        popup2.updatePopUp(ch_id); // to fix. should be channel id returned from the backend
                        return document.getElementById(popupDeltaId).innerHTML;
                      }
                });
				
				/**/
				$(".channel-share" + bulk).click(function(){
					ch_id = $(this).attr('id');
					ch_id = ch_id.substring(9, ch_id.length);
					if (webshare) {
						const shareData = {url: channelbase + ch_id};
						navigator.share(shareData)
						.then(() => console.log('Successful share'))
						.catch((error) => console.log('Error sharing', error));
					} else {
						$(".channel-share" + bulk).popover({  //  .on('popover', function (e) {
							//e.preventDefault();
						placement: 'right',
						container: 'body',
						html: true,
						content: function() {
							popup.updatePopUp(channelbase + ch_id); // to fix. should be channel id returned from the backend
							return document.getElementById(popupShareId).innerHTML;
						}
						});
					}
				});

                $(".channel-template" + bulk).on('shown.bs.popover', function () {
					$(".tmpltbtn").removeClass("selected");
					$(".tmp_" + objsheader.template).addClass("selected");
                    $('.tmpltbtn').on('click',function(e) {
                    	e.preventDefault();
                    	let poststring = "channel_id=" + ch_id + "&ptype=template&pvalue=" + $(this).attr('tmplt');
                    	let clckdBtn = this;
                    /**/
                    	let actn = '/?route=retailer/channel/update';
						if (!(this.getAttribute("class").includes("selected"))) {
							$.ajax({
							type: "POST",
							url: actn,
							data: poststring,
							dataType: "json",
							success: function(data)
							{
								$(".tmpltbtn").removeClass("selected");
								objsheader.template = clckdBtn.getAttribute("tmplt");
								$(clckdBtn).addClass("selected");
								//$("#tmpltpreview").attr("href",baseurl + '42/apps/' + $(this).attr('tmplt') + '.html?channel=' + ch_id);
								//baseurl + '/42/apps/cards.html?channel=';
								//mark button as selected: remove from all buttons the css class. add the css class to $(this)
								//change the "preview" link destination and color
							},
								error: function(data) {
									console.log('error: ');
									document.getElementById('errormsg').innerHtml = data.reason;
									console.log(data);
									
									
								}
								
							});
						}
						   
                    /**/	 
                     });    
                
                });
                /**/
        
                $(".channel-template" + bulk).popover({
                      placement: 'right',
                      container: 'body',
                      html: true,
                      content: function() {
                      ch_id = $(this).attr('id');
                      ch_id = ch_id.substring(9, ch_id.length);
                        return document.getElementById('template-selector').innerHTML;
                      }
                });

	};
	
	/**/
	var scrollEvents = function() {

	    		//on scroll. no jQuery !
	    //let feedsrc = feedlink;
	    let shouldTriggerScroll = true;
        var navbar = document.getElementById("topbar");
        var sticky = 46; //topbar.offsetTop;
	    
		window.onscroll = function () {
		stickMenu();
		loadOnScroll();
		}
		


		function draw() {
			sliceat = Math.max(Math.min(displayamount,listlength - currentdisplay),0);
			aggitems = laf.objSlice(objsjson[ctrlr.loopsobj],currentdisplay, currentdisplay + sliceat);
			bulk++;
			//loopitems(aggitems,ctrlr.func);
			$("#main").append(loopitems(aggitems,ctrlr.func));
			window[ctrlr.eventTriggers](bulk);

			currentdisplay += sliceat;
			listlength += laf.isError(aggitems.length,0);
			shouldTriggerScroll = true;
    	}
    	
    	function loadOnScroll(){
			if(Math.abs(window.scrollY - (document.documentElement.scrollHeight - window.innerHeight)) < 1) {
				   // ajax call get data from server and append to the div
				   var aggitems = {};
					if (currentdisplay > 0) {
					    //console.log('listlength - currentdisplay (should be less than 1): ' + (listlength - currentdisplay));
						if ((listlength - currentdisplay < 1) && shouldTriggerScroll) {
						    //window.scrollBy(0, -25);
                            shouldTriggerScroll = false;
                            document.getElementById("countdown").style.display = "block";
                                    fetch(feedsrc  + '&limstart=' + listlength + '&limend=' + (listlength + displayamount) , {
                                      method: 'GET'
                                    })
                                    .then(function(response) {
                    					return validateFetch(response);
                                    })
                                    .then(function(response) { 
                                        return response.json();
                                    })
                                    .then(function(json) {
                            			// add json.items to the global object items
                            			let Unioner = {};
                            			if (ftype == 'fbt' || ftype == 'flows' || ftype == 'rsearch') {
                            			    Unioner = json['feed'];
                            			} else {
                            			    Unioner = json['feed']['items'];
                            			}
                            			objsjson[ctrlr.loopsobj] = laf.objUnionAll(objsjson[ctrlr.loopsobj],Unioner);
                            			tagsarray = laf.objUnionAll(tagsarray,json['tagsarray'],true);
                            			listlength = Object.keys(objsjson[ctrlr.loopsobj]).length; // the current length of the list
                            			// move to the function
                            		    draw();
                            		    document.getElementById("countdown").style.display = "none";
                                    });
						} else if (shouldTriggerScroll && (listlength - currentdisplay > 0)) {
						    draw();
						}
						

					}
					
			}
    	    
    	}
	
    	/*https://www.w3schools.com/howto/tryit.asp?filename=tryhow_js_navbar_sticky*/
    	function stickMenu() {
          if (window.pageYOffset >= sticky) {
            navbar.classList.add("sticky")
          } else {
            navbar.classList.remove("sticky");
            }
    	}
    	
	};
	/**/
</script>
<script type="text/Javascript">

// global functions

	window.onerror = function (msg, url, lineNo, columnNo, error) {

		var message = [
		'Message: ' + msg,
		'URL: ' + url,
		'Line: ' + lineNo,
		'Column: ' + columnNo,
		'Error object: ' + JSON.stringify(error)
		].join(' - ');
		console.log(message);

		if (alreadyrestarted == 1) {
			window.location.href = baseurl;
		} else {
			alreadyrestarted = 1;
			delete localStorage['42knots,objsjson'];
			delete localStorage['42knots,constants'];
			routeto2("start");
		}


	}

		$(window).ready(function() {
			// check for cache
			/**/
			//console.log("typeof localStorage['42knots,objsjson'] !== 'undefined': " + localStorage['42knots,objsjson'] + ", typeof: " + typeof localStorage['42knots,objsjson'] + " && localStorage['42knots,objsjson'].length: " + localStorage['42knots,objsjson'].length + ", (typeof localStorage['42knots,constants']: " + localStorage['42knots,constants'] +  ", typeof: " + typeof localStorage['42knots,constants']);
			if (typeof localStorage['42knots,objsjson'] !== 'undefined' && localStorage['42knots,objsjson'].length > 2 && (typeof localStorage['42knots,constants'] !== 'undefined')) {
				objsjson = JSON.parse(localStorage['42knots,objsjson']);
				ftype = (' ' + objsjson.ftype).slice(1);
				delete objsjson['ftype'];
				constants = JSON.parse(localStorage['42knots,constants']);
				setConstants(constants);
				init();
			}

			fetch('/?route=retailer/login/setup',
				{
					method: "GET",
				})
				.then(function(res){
					return res.json();
				})
				.then(function(json){
					if(json.status == 'notLogged') {
						window.location.replace("/");
					} else {
						inituser();
					}
				});
				

		});

    	function loadOnRefresh() {
			document.getElementById("countdown").style.display = "block";
			fetch((feedsrc  + '&limstart=0&limend=' + minload) , {
				method: 'GET'
			})
            .then(function(response) {
				return validateFetch(response);
            })
			.then(function(response) { 
				return response.json();
			})
			.then(function(json) {
				let arr = [];
				let de = {};
				// convert the received object to an array
				for (let i = 0; i < json['feed']['items'].length; i++) {
					arr.push(json['feed']['items'][i]['item_id']);
					tagsarray[json['feed']['items'][i]['item_id']] = json['tagsarray'][json['feed']['items'][i]['item_id']];
					de[json['feed']['items'][i]['item_id']] = i; // item_id - the key, i - it;s location, as value
				}
				// find the location of a match, if any
				let sat = arr.indexOf(objsjson['feed'][0].item_id);
				if(sat > 0) {
					sliceditems = laf.objSlice(json['feed']['items'],0,sat);
					objsjson[ctrlr.loopsobj] = laf.objUnionAll(sliceditems,objsjson[ctrlr.loopsobj]);
					listlength = Object.keys(objsjson[ctrlr.loopsobj]).length; // the current length of the list
					bulk--;
					$(loopitems(sliceditems,ctrlr.func)).insertAfter(".channel");
					window[ctrlr.eventTriggers](bulk);
				}
			document.getElementById("countdown").style.display = "none";
			});
    	}

		setInterval(loadOnRefresh, 3000000); // 


function setConstants(constants) {
        const getroute = '?route=';
        //ftype = constants['ftype'];
        baseurl = constants['baseurl'];
        me = constants['me'];
		fortytwobase = baseurl + '42/';
		// get personal data
        
        // links set
        ftype = constants['ftype'];
        actbase = getroute + 'retailer/obj'; // constants['actbase'];
        retaileredit = getroute + 'retailer/update'; // constants['retaileredit'];
        tagsaction = getroute + 'retailer/tags/edittags'; //constants['retaileredit'];
        //feedlink = constants['feedlink'];
		faction = actbase + '&otype=item'; //constants['faction'];
        
        // attribution set
		$("#fetchform").attr('action',faction);
		$("#change_password").attr('action',retaileredit);
        $("html").attr('dir',constants['direction']);
        $("html").attr('lang',constants['lang']);
		$("base").attr('href',baseurl);

		//
		feedlink = baseurl + 'index.php?route=retailer/app/json';
		feedsrc = feedlink + '&ftype=' + ftype;
		channelbase = baseurl + '42/6x7.php?v=webapp&channel=';


}

$("#rtout").click(function(){

    fetch('/?route=retailer/logout', {
          method: 'GET'
        })
        .then(function(response) {
			return validateFetch(response);
        })
        .then(function(response) {
            return response.json();
            
        })
        .then(function(json) {
            console.log(json);
            if (json['status'] == 'ok') {
                window.location.replace("/");
            }
        })
    
});

/*
$(".route").click(function(e){
    e.preventDefault();
    routeto($(this).attr('id'));
    
});
*/

$(".route2").click(function(e){
    e.preventDefault();
    routeto2($(this).attr('id'));
    
});




$("#menu").click(function(e){
    e.preventDefault();
	sidelm = document.getElementById("sidebar");
	if (sidelm.classList.contains('hidden')) {
		sidelm.classList.remove('hidden');
	} else {
		sidelm.classList.add('hidden');
	}
});


$("#backwardsbtn").click(function(){
    if (typeof routehistory !== 'undefined' && routehistory.length > 0) {

		objsjson = routehistory.pop(); //JSON.parse(json);
		ftype = (' ' + objsjson.ftype).slice(1);
		delete objsjson['ftype'];
		init();
		scrollEvents();
    }
});

$('.change_password').on('submit',function(e) {
	e.preventDefault();
	var actn = $(this).attr('action');

	$.ajax({
	   type: "POST",
	   url: actn,
	   data: $(this).serialize(),
	   dataType: "json",
	   success: function(data)
	   {
	    console.log(data);
		$("[id*=popover]").remove();
	   },
		error: function(data) {
			console.log('error updating password: ');
			document.getElementById('errormsg').innerHtml = data.reason;
			console.log(data);
			
			
		}
		
	   });
	 
 });    




</script>
</body>
</html>